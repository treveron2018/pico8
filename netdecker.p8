pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
--netdecker

--by treveron

function _init()
	t=0
	p={
	x=8,
	y=96,
	ox=0,
	oy=0,
	sox=0,
	soy=0,
	t=0,
	_spr=49,
	_flip=false,
	mov=nil,
	ani={48,49,50,51,52,53}
	}
	dirx={-8,8,0,0}
	diry={0,0,-8,8}
	wind={}
	_upd=update_game
	_drw=draw_game
	buttbuff=-1
end

function _update60()
	t+=1
	_upd()
end

function _draw()
	cls()
	_drw()
	drawind()
end

function update_game()
	if(buttbuff==-1)buttbuff=getbutt()
	dobutt(buttbuff)
	buttbuff=-1
end

function draw_game()
	map()
	draw_player()
--print(debug,0,0,7)
end
-->8
--player functions

function move_player(d)
	local dx,dy=dirx[d+1],diry[d+1]
	
	if dx<0 then
		p._flip=true
	elseif dx>0 then
		p._flip=false
	end
	
	local destx,desty=(p.x+dx)/8,(p.y+dy)/8
	local tle=mget(destx,desty)

	if fget(tle,0)then
		p.sox,p.soy,p.ox,p.oy=dx,dy,0,0				
		p.mov=mov_bump
		if(fget(tle,1))trig_bump(tle,destx,desty)
	else
		p.x+=dx
		p.y+=dy
		p.ox+=-dx
		p.oy+=-dy
		p.sox,p.soy=-dx,-dy
		p.mov=mov_walk	
	end
	p.t=0
	_upd=update_pturn
end

function draw_player()
	draw_spr(p.ani[get_frame(p.ani)],p.x+p.ox,p.y+p.oy,10,p._flip)
end

function update_pturn()
	if(buttbuff==-1)buttbuff=getbutt()
	p.t=min(p.t+0.125,1)
	p.mov()
	if(p.t==1)_upd=update_game
end

function mov_walk()
		p.ox,p.oy=p.sox*(1-p.t),p.soy*(1-p.t)
end

function mov_bump()
	local tme=p.t
	if(tme>0.5)tme=1-p.t
	p.ox=p.sox*tme
	p.oy=p.soy*tme
end

function trig_bump(tle,destx,desty)
	if tle==11 or tle==12 then
		mset(destx,desty,3)
	elseif tle==6 or tle==8 then
		mset(destx,desty,tle+1)
	elseif tle==10 then
		mset(destx,desty,3)	
	elseif tle==13 then
		show_msg("it begins...",120)
	end
end
-->8
--tools

function get_frame(ani)
	return flr(t/8)%#ani+1
end

function draw_spr(_spr,_x,_y,_c,_flip)
	palt(0,false)
	pal(6,_c)
	spr(_spr,_x,_y,1,1,_flip)
	pal()
	palt()
end

function getbutt()
	for i=0,5 do
		if(btnp(i))return i
	end
	return -1
end

function dobutt(butt)
	if(butt<0)return
	if butt<4 then
		move_player(butt)
	end
end
-->8
--ui

function addwind(_x,_y,_w,_h,_txt,_dur)
	local w={
	x=_x,
	y=_y,
	w=_w,
	h=_h,
	txt=_txt,
	dur=_dur}
	add(wind,w)
	return w
end

function rectfill2(_x,_y,_w,_h,_c)
	rectfill(_x,_y,_x+_w-1,_y+_h-1,_c)
end

function drawind()
	for w in all(wind) do
		local wx,wy,ww,wh=w.x,w.y,w.w,w.h
		rectfill2(wx,wy,ww,wh,0)
		rectfill2(wx+1,wy+1,ww-2,wh-2,7)
		rectfill2(wx+2,wy+2,ww-4,wh-4,0)
		wx+=4
		wy+=4
		clip(wx,wy,ww-8,wh-8)
		for i=1,#w.txt do
			local txt=w.txt[i]
			print(txt,wx,wy,6)
			wh+=6
		end
		if w.dur then
			w.dur-=1
			if(w.dur<=0)del(wind,w)
		end
	end
end

function show_msg(txt,dur)
	local wid=#txt*4+7
	local w=addwind(63-wid/2,50,wid,13,{txt},dur)
end
__gfx__
00000000666666606666666000000000aaaaaaa05555555000aaa0000055500000000000000000000aaaaaa00aaa00000aa0aa00aaaaaaa00000000000000000
000000000606060066666000000000000a000a00055555000a000a000500050000aaa00000555000a000000000aa000000a0a000a00000a00000000000000000
007007006066606066660660000000000a000a0005000500a0aaa0a0505050500aaaaa0005555500a00000a000aa000000a0a000a0aaaaa00000000000000000
000770006066606066000660000000000a000a0005000500a00000a0505050500aa0aa0005050500aa0000000a0a000000a0a000a00000a00000000000000000
000770006066606066066660000500000a000a0005000500a0aaa0a0505050500a000a0005505500a00000a0a000a0000a000a0000a0aa000000000000000000
007007000606060000666660000000000aaaaa0005000500aa000aa0550005500aa0aa0005050500a0000000a000a000a00000a0a00000a00000000000000000
00000000666666606666666000000000aaaaaaa055555550aaaaaaa0555555500aaaaa00055555000aaaaaa00aaa0000aaaaaaa0aaaaaaa00000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00666000066666000066600000666000006660000066600000000000000000000000000000000000000000000000000000000000000000000000000000000000
06666600006660000600060006000600060006000660060000000000000000000000000000000000000000000000000000000000000000000000000000000000
00666000060006000600060006000600060006000660060000000000000000000000000000000000000000000000000000000000000000000000000000000000
06000600060006006666666066666660666666606666666000000000000000000000000000000000000000000000000000000000000000000000000000000000
06000600666666606066606060666060606660606066606000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666660606660600066600000666000006060000060600000000000000000000000000000000000000000000000000000000000000000000000000000000000
60666060006660000666660006606600066066000660660000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00666000006660000000000000666000006660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
06600600066006000066600006600600066006000066600000000000000000000000000000000000000000000000000000000000000000000000000000000000
06600600666006000660060006600600066006600660060000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666660666666606660066066666660666666606660066000000000000000000000000000000000000000000000000000000000000000000000000000000000
60666060006660606666666060666060606660006666666000000000000000000000000000000000000000000000000000000000000000000000000000000000
00606000006066000066600000606000066060000066600000000000000000000000000000000000000000000000000000000000000000000000000000000000
06606600066000000660660006606600000066000660660000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001010000000303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
02060303030303020c0b0b0d0203040200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020b03030303030a0c0b0c0b0203030200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020c0303030303020303030302020a0200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020202020202020203030303020c030200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020c0303030b0c0203030303020c030200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0203030303030c0203030303020c030200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020303030303030203030303020b030200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020202020a02020203030202020b030200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0208030303030e02030302030303030200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
020303030303030a03030a030303030200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0203030303030302030302030303030200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0205030303030302030302030303080200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
